<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>User Directory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>
    <div class="app-shell">
        <header class="navbar">
            <div class="nav-brand">USER MGMT</div>
            <div class="nav-links">
                <a href="index.html">Login</a>
                <a href="upload.html">Upload</a>
                <a href="users.html" class="active">Users</a>
                <a href="migrate.html">Migrate</a>
            </div>
        </header>

        <main class="page">
        <div class="card">
            <div class="table-toolbar">
                <div class="field-inline">
                    <input id="search" type="text" placeholder="Search by name, email, phone"/>
                    <span class="pill" id="countPill">0 users</span>
                </div>
                <button id="refresh">Refresh</button>
            </div>

            <table id="usersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>DOB</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Gender</th>
                        <th>Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        </main>
    </div>

    <script>
        async function fetchUsers() {
            const res = await fetch('/api/users');
            return await res.json();
        }

        function render(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            for (const u of users) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Name">${escapeHtml(u.name)}</td>
                    <td data-label="DOB">${escapeHtml(u.dob)}</td>
                    <td data-label="Email">${escapeHtml(u.email)}</td>
                    <td data-label="Phone">${escapeHtml(u.phone)}</td>
                    <td data-label="Gender">${escapeHtml(u.gender)}</td>
                    <td data-label="Address">${escapeHtml(u.address)}</td>
                    <td data-label="Actions">
                        <button data-id="${u.email}" class="delete">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            }

            document.querySelectorAll('.delete').forEach(b => {
                b.addEventListener('click', async () => {
                    const id = b.getAttribute('data-id');
                    if (!confirm('Delete user ' + id + '?')) return;

                    const resp = await fetch('/api/users/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'id=' + encodeURIComponent(id)
                    });

                    if (resp.ok) loadAndRender();
                    else alert('Failed to delete');
                });
            });
        }

        function filterUsers(users, q) {
            if (!q) return users;
            q = q.toLowerCase();
            return users.filter(u =>
                (u.name || '').toLowerCase().includes(q) ||
                (u.email || '').toLowerCase().includes(q) ||
                (u.phone || '').toLowerCase().includes(q)
            );
        }

        function escapeHtml(s) {
            if (!s) return '';
            return s.replaceAll('&','&amp;')
                    .replaceAll('<','&lt;')
                    .replaceAll('>','&gt;');
        }

        async function loadAndRender() {
            const users = await fetchUsers();
            const q = document.getElementById('search').value;
            const filtered = filterUsers(users, q);
            render(filtered);
            const pill = document.getElementById('countPill');
            pill.textContent = filtered.length + ' user' + (filtered.length === 1 ? '' : 's');
        }

        document.getElementById('refresh').addEventListener('click', loadAndRender);
        document.getElementById('search').addEventListener('input', loadAndRender);
        window.addEventListener('load', loadAndRender);
    </script>
</body>
</html>
