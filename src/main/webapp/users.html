<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>User Directory</title>
</head>
<body>
    <h2>Users</h2>
    <input id="search" placeholder="Search by name, email, phone"/>
    <button id="refresh">Refresh</button>
    <table border="1" id="usersTable">
        <thead>
            <tr>
                <th>Name</th><th>DOB</th><th>Email</th><th>Phone</th><th>Gender</th><th>Address</th><th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
        async function fetchUsers() {
            const res = await fetch('/api/users');
            const data = await res.json();
            return data;
        }

        function render(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            for (const u of users) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.dob)}</td><td>${escapeHtml(u.email)}</td><td>${escapeHtml(u.phone)}</td><td>${escapeHtml(u.gender)}</td><td>${escapeHtml(u.address)}</td>
                <td><button data-id="${u.email}" class="delete">Delete</button></td>`;
                tbody.appendChild(tr);
            }
            document.querySelectorAll('.delete').forEach(b => {
                b.addEventListener('click', async (ev) => {
                    const id = b.getAttribute('data-id');
                    if (!confirm('Delete user ' + id + '?')) return;
                    const resp = await fetch('/api/users/delete', { method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded'}, body: 'id=' + encodeURIComponent(id) });
                    if (resp.ok) {
                        loadAndRender();
                    } else {
                        alert('Failed to delete');
                    }
                });
            });
        }

        function filterUsers(users, q) {
            if (!q) return users;
            q = q.toLowerCase();
            return users.filter(u => {
                return (u.name || '').toLowerCase().includes(q) ||
                       (u.email || '').toLowerCase().includes(q) ||
                       (u.phone || '').toLowerCase().includes(q);
            });
        }

        function escapeHtml(s) {
            if (!s) return '';
            return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
        }

        async function loadAndRender() {
            const users = await fetchUsers();
            const q = document.getElementById('search').value;
            render(filterUsers(users, q));
        }

        document.getElementById('refresh').addEventListener('click', loadAndRender);
        document.getElementById('search').addEventListener('input', loadAndRender);
        window.addEventListener('load', loadAndRender);
    </script>
</body>
</html>

